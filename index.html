<h1>Device Web API Test</h1>
<button type="button" onclick="onButtonClick()">requestPermission</button>
<button type="button" onclick="onEmulationClick()">Emulation</button>
<h3>Output</h3>
<div id="output" class="output">
  <h2>window</h2>
  <div id="window">
    <label>Orientation:</label>
    <input type="text" class="orientation"/>
  </div>
  <h2>device motion</h2>
  <div id="devicemotion">
    <table>
      <tr>
        <td>Interval:</td>
        <td><input type="number" class="interval" style="text-align:right"/></td>
      </tr>
      <tr>
        <td>Timestamp:</td>
        <td><input type="number" class="timeStamp" style="text-align:right"/></td>
      </tr>
    </table>
    <h3>acceleration</h3>
    <div id="acceleration">
      <table>
        <tr>
          <td>X:</td>
          <td><input type="number" id="ax" style="text-align:right"/></td>
        </tr>
        <tr>
          <td>Y:</td>
          <td><input type="number" id="ay" style="text-align:right"/></td>
        </tr>
        <tr>
          <td>Z:</td>
          <td><input type="number" id="az" style="text-align:right"/></td>
        </table>
        <canvas id="accelerationChart"></chart>
    </div>
    <h3>acceleration including gravity</h3>
    <div id="accelerationIncludingGravity">
      <table>
        <tr>
          <td>X:</td>
          <td><input type="number" id="aigx" style="text-align:right"/></td>
        </tr>
        <tr>
          <td>Y:</td>
          <td><input type="number" id="aigy" style="text-align:right"/></td>
        </tr>
        <tr>
          <td>Z:</td>
          <td><input type="number" id="aigz" style="text-align:right"/></td>
        </tr>
      </table>
      <canvas id="accelerationIncludingGravityChart"></chart>
    </div>
  </div>
  <h2>device orienation</h2>
  <div id="deviceorientation">
    <table>
      <tr>
        <td>Absolute:</td>
        <td><input type="text" class="absolute" /></td>
      </tr>
      <tr>
        <td>Timestamp:</td>
        <td><input type="number" class="timeStamp" style="text-align:right"/></td>
      </tr>
    </table>
    <h3>rotation rate</h3>
    <div id="rotationRate">
      <table>
        <tr>
          <td>ALPHA:</td>
          <td><input type="number" id="alpha" style="text-align:right"/></td>
        <tr>
          <td>BETA:</td>
          <td><input type="number" id="beta" style="text-align:right"/></td>
        </tr>
        <tr>
          <td>GAMMA:</td>
          <td><input type="number" id="gamma" style="text-align:right"/></td>
        </tr>
      </table>
      <canvas id="rotationRateChart"></chart>
    </div>
  </div>
  <h2>compass need calibration</h2>
  <div id="compassneedcalibration">
    <label>Need Calibration:</label>
    <input type="text" class="need"/><br/>
  </div>
  <div id="status"></div>
  <pre id="log"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@1.27.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>

<script>

Chart.defaults.set('plugins.streaming', {
  duration: 2000,
  frameRate: 5,
  pause: true
});
Chart.defaults.animation = false;
Chart.defaults.responsive = false;
Chart.defaults.maintaionAspectRatio = false;
Chart.defaults.plugins.legend.position = 'charArea';
//Chart.defaults.scales.x.type = 'realtime';

const aConfig = {
  type: 'line',
  data: { datasets: [ 
    {label:'x', borderColor:'rgb(255,0,0)', data:[]}, 
    {label:'y', borderColor:'rgb(0,255,0)', data:[]}, 
    {label:'z', borderColor:'rgb(0,0,255)', data:[]} 
  ]},
  options: {
    scales: { x: { type: 'realtime' } }
  }
};
const aCtx = document.getElementById('accelerationChart').getContext('2d');
const aChart = new Chart(aCtx, aConfig);

const gConfig = {
  type: 'line',
  data: { datasets: [
    {label:'x', borderColor:'rgb(255,0,0)', data:[]},
    {label:'y', borderColor:'rgb(0,255,0)', data:[]},
    {label:'z', borderColor:'rgb(0,0,255)', data:[]}
  ]},
  options: {
    scales: { x: { type: 'realtime' } }
  }
};
const gCtx = document.getElementById('accelerationIncludingGravityChart').getContext('2d');
const gChart = new Chart(gCtx, gConfig);

const rConfig = {
  type: 'line',
  data: { datasets: [
    {label:'alpha', borderColor:'rgb(255,0,0)', data:[]},
    {label:'beta',  borderColor:'rgb(0,255,0)', data:[]},
    {label:'gamma', borderColor:'rgb(0,0,255)', data:[]}
  ]},
  options: {
    scales: { x: { type: 'realtime' } }
  }
};
const rCtx = document.getElementById('rotationRateChart').getContext('2d');
const rChart = new Chart(rCtx, rConfig);

document.addEventListener("load", function() {
  aCtx.canvas.width = document.get.ElementById('acceleration').width();
  aCtx.canvas.height = 250;

});

function log(line) {
  document.querySelector('#log').textContent += line + '\n';
  console.log(line);
}

async function onDeviceMotion(event) {
  document.querySelector('#devicemotion .interval' ).value  = event.interval.toFixed(6);
  document.querySelector('#devicemotion .timeStamp').value = event.timeStamp.toFixed(3);

  document.querySelector('#ax').value = event.acceleration.x.toFixed(3);
  document.querySelector('#ay').value = event.acceleration.y.toFixed(3);
  document.querySelector('#az').value = event.acceleration.z.toFixed(3);

  document.querySelector('#aigx').value = event.accelerationIncludingGravity.x.toFixed(3);
  document.querySelector('#aigy').value = event.accelerationIncludingGravity.y.toFixed(3);
  document.querySelector('#aigz').value = event.accelerationIncludingGravity.z.toFixed(3);

  document.querySelector('#window > .orientation').value = window.orientation;

  aChart.data.datasets[0].data.push({x:Date.now(), y:event.acceleration.x});
  aChart.data.datasets[1].data.push({x:Date.now(), y:event.acceleration.y});
  aChart.data.datasets[2].data.push({x:Date.now(), y:event.acceleration.z});
  aChart.update();

  gChart.data.datasets[0].data.push({x:Date.now(), y:event.accelerationIncludingGravity.x});
  gChart.data.datasets[1].data.push({x:Date.now(), y:event.accelerationIncludingGravity.y});
  gChart.data.datasets[2].data.push({x:Date.now(), y:event.accelerationIncludingGravity.z});
  gChart.update();
}

async function onDeviceOrientation(event) {
  document.querySelector('#deviceorientation .absolute' ).value = event.absolute;
  document.querySelector('#deviceorientation .timeStamp').value = event.timeStamp.toFixed(3);

  document.querySelector('#alpha').value = event.alpha.toFixed(3);
  document.querySelector('#beta' ).value = event.beta.toFixed(3);
  document.querySelector('#gamma').value = event.gamma.toFixed(3);

  rChart.data.datasets[0].data.push({x:Date.now(), y:event.alpha});
  rChart.data.datasets[1].data.push({x:Date.now(), y:event.beta});
  rChart.data.datasets[2].data.push({x:Date.now(), y:event.gamma});
  rChart.update();
}

async function onCompassNeedCalibration(event) {
  document.querySelector('#compassneedcalibration .need').value = 'true';
}

async function onButtonClick() {
  onDeviceMotion({"interval":0, "timeStamp":0, "acceleration":{"x":0, "y":0, "z":0}, "accelerationIncludingGravity":{"x":0, "y":0, "z":0}});
  onDeviceOrientation({"absolute":"absolute", "timeStamp":0, "alpha":0, "beta":0, "gamma":0});
  onCompassNeedCalibration({});

  try {
    if (DeviceMotionEvent.requestPermission) {
      const state = await DeviceMotionEvent.requestPermission();
      if (state === 'granted') {
        window.addEventListener("devicemotion", onDeviceMotion);
        window.addEventListener("deviceorientation", onDeviceOrientation);
        window.addEventListener("compassneedscalibration", onCompassNeedCalibration);
        aConfig.options.scales.x.realtime.pause = false;
      } else {
        alert('not permitted!');
      }
    } 
  } catch (error) {
    log('Argh! ' + error);
    log(error.stack);
  }
}

let interval = 10;

async function emu() {
  onDeviceMotion({
    "interval":interval/1000, 
    "timeStamp":0, 
    "acceleration":{"x":Math.random(), "y":Math.random(), "z":Math.random()}, 
    "accelerationIncludingGravity":{"x":Math.random(), "y":Math.random(), "z":Math.random()}
  });
  onDeviceOrientation({"absolute":"absolute", "timeStamp":0, "alpha":Math.random(), "beta":Math.random(), "gamma":Math.random()});
  onCompassNeedCalibration({});
}

async function onEmulationClick() {
  aConfig.options.scales.x.realtime.pause = false;
  gConfig.options.scales.x.realtime.pause = false;
  rConfig.options.scales.x.realtime.pause = false;
  setInterval(emu, interval);
}

</script>
